# Анализ пространственных соотношений {#spatrelations}

[Архив с данными и файлом отчёта](){target="_blank"}

## Введение {#spatrelations-intro}

**Цель задания** — научиться рассчитывать соотношение различных явлений на регулярной сетке с использованием векторного оверлея.

**Необходимая теоретическая подготовка:** Оверлей пространственных объектов, геометрическое определение вероятности как отношения мер (площадей), соединение таблиц в реляционных базах данных, внешний и внутренний ключ соединения.

**Необходимая практическая подготовка:** Знание основных компонент интерфейса QGIS (менеджер источников данных, таблица слоёв, фрейм карты, менеджер компоновок). Работа с различными форматами источников пространственных данных . Настройка символики и подписей объектов. Владение базовыми ГИС-технологиями.

**Исходные данные:** .

**Результат:** карта соотношения различных типов объектов.

### Контрольный лист {#spatrelations-control}

* Добавить на карту слои типов объектов и регулярную сетку, оформить их
* Произвести оверлей и слияние объектов в пределах ячеек
* Рассчитать площадь объектов
* Присоединить поля площади к таблице регулярной сетки и рассчитать площадь оставшихся объектов
* Визуализировать результат

### Аннотация {#spatrelations-annotation}

Задание посвящено знакомству с пространственным анализом на основе векторных данных. Векторная модель представляет объекты в виде отдельных геометрических фигур с набором атрибутов. Она является объектно-ориентированной и удобна для анализа формы, размеров объектов, их взаимной конфигурации в пространстве.  Одним из широко используемых методов анализа на основе векторных данных является оверлей.

> При *оверлее* происходит наложение двух или более слоев, в результате чего образуется их графическая композиция. Полученные участки наследуют атрибуты от каждого слоя. Эта операция базируется на стандартных отношениях множеств, таких как пересечение, объединение и симметрическая разность.

С помощью оверлея можно, например, установить, как соотносятся площади объектов разных типов в пределах ячеек регулярной сетки. Это может быть важно при моделировании, например, локальных климатических зон или анализе экологической ситуации.

## Визуальный анализ векторных слоев {#spatrelations-vizual}
[В начало упражнения ⇡](#spatrelations)

В первую очередь при анализе данных следует провести их визуальную оценку, которая может натолкнуть на отыскание закономерностей во взаимном расположении объектов.

1. Распакуйте архив с материалами упражнения в свою рабочую директорию. Создайте проект QGIS в папке с распакованными материалами.

2. Добавьте на карту слои *Industrial*, *Hydro*, *Green*, *Buildings* из базы данных `LandCover.gpkg`. Присвойте этим слоям разные цвета для лучшего восприятия данных.

    ![](images/Ex06_SpatRelations/Layers.png)
    
4. Создайте регулярную сетку квадратов **Vector – Research tools – Create Grid**. В открывшемся окне параметров инструмента выберите необходимый тип сетки, укажите вертикальный и горизонтальный шаг сетки в 1000 м, а в качестве экстента (охвата) слоя укажите существующий слой проекта *Buildings*. Уберите заливку полученного слоя и переместите его наверх.

    **Скриншот 1:** Визуализация исходных данных

    ![](images/Ex06_SpatRelations/Grid.png)

## Расчёт площадей и оверлей {#spatrelations-overlay}
[В начало упражнения ⇡](#spatrelations)
    
1. Для расчёта доли площади каждого типа объекта в пределах ячейки необходимо рассчитать площадь самой ячейки. Для этого откройте атрибутивную таблицу слоя и выберите кнопку ![](images/Ex06_SpatRelations/FieldCalculator.png). В открывшемся окне убедитесь, что вы создаете новое поле. Укажите имя поля *CellArea*, выберите соответствующий тип поля. Для расчёта используйте команду *$area*.

    Пояснение: `area()` — системная функция QGIS, возвращающая площадь объекта. Значок `$` означает, что функция будет применена к текущему объекту. Площадь вычисляется в единицах измерения площади, предусмотренных для системы координат источника данных. Для проецированных систем координат это, как правило, метры (реже футы).

**Вопрос 1:** Почему рассчитанная площадь не равна 1000000?

2. Для того чтобы рассчитать площади каждого типа объекта в пределах ячеек регулярной сетки, необходимо выполнить операцию пересечения (оверлея) слоев. Для этого воспользуйтесь инструментом Vector Overlay - Intersection. В качестве параметра *Input layer*  укажите регулярную сетку, а в качестве *Overlay layer* укажите слой с растительностью. Результирующий слой будет называться *Intersect* – переименуйте его так, чтобы было понятно, в результате пересечения каких именно слоев он получился.

> Временный слой в QGIS хранится в выделенной директории среди системных файлов. Если не сохранять временные файлы, они будут удалены после закрытия окна QGIS. Временные слои обозначаются соответствующим значком справа от названия в таблице слоёв.

**Вопрос 2:** Чем отличается полученный слой от исходного слоя растительности визуально?

**Вопрос 3:** Чем отличается полученный слой от исходного слоя растительности по структуре таблицы атрибутов?

3. Повторите аналогичную операцию для оставшихся трёх слоёв.

4. Обратите внимание, что в полученных слоях в пределах ячейки мы видим, как правило, не один объект, а несколько. Мы можем рассчитать площадь каждого из них, но нам нужна суммарная площадь всех объектов.

    ![](images/Ex06_SpatRelations/Separate_polygons.gif)

Для получения общей площади можно превратить все полигоны в пределах ячеек в мультиполигоны. Воспользуемся для этого инструментом слияния по значению атрибута – после оверлея полигонов у каждого объекта растительности появился уникальный идентификатор ячейки регулярной сетки *id*. Воспользуйтесь инструментом **Vector – Geoprocessing Tools – Dissolve**. В качестве параметров инструмента необходимо указать слой и поле атрибута, по которому будет осуществляться слияние. Результирующий временный слой будет называться *Dissolved* – переименуйте его так, чтобы было понятно, о каком типе объектов идёт речь.

5. Повторите аналогичную операцию для оставшихся трёх слоёв.

6. Рассчитайте площади для каждого слитого слоя с помощью калькулятора полей.

## Соединение таблиц по ключевому полю {#spatrelations-join}
[В начало упражнения ⇡](#spatrelations)

На данном этапе у вас должны быть 4 слоя с известными площадями объектов в ячейках и собственно слой ячеек, для которых рассчитана площадь. Для дальнейшего анализа нам необходимо совместить атрибутивные таблицы всех этих слоёв.

> *Соединение таблиц* (table join) — операция, в результате которой к одной таблице временно добавляются столбцы из другой таблицы. Чтобы установить соответствие между строками исходной и присоединяемой таблицы, необходимо иметь в каждой таблице поле с общими для них значениями. Например, это может быть числовой код объекта.

1. Зайдите в свойства слоя регулярной сетки. Слева окна найдите вкладку *Joins* – добавить новое соединение можно через кнопку плюса внизу. Откроется окно, в котором нужно выбрать слой, атрибутивную таблицу которого мы хотим присоединить, а также ключевые поля, хранящие общие значения – в нашем случае это поля *id*. Установите галочку напротив *Joined fields*, чтобы выбрать поля, которые нужно присоединить – кроме поля площади нам ничего не нужно.

    ![](images/Ex06_SpatRelations/Add_Vector_Join.png)

2. Проделайте аналогичную операцию для остальных трёх слоёв.

## Расчёт площадей прочих объектов {#spatrelations-other}
[В начало упражнения ⇡](#spatrelations)

Четыре типа объектов покрывают далеко не всю территорию, поскольку есть и иные объекты, которые в нашем случае не берутся в расчёт. Для корректного анализа и визуализации необходимо рассчитать оставшуюся площадь для каждой ячейки. Это можно сделать, отняв из площади ячейки площади всех объектов каждого типа. Проще всего для такой задачи воспользоваться калькулятором поля. Однако тут возникает проблема: в атрибутивной таблице встречаются значения *Null* в полях площадей, которые обозначают отсутствие данных. Такое значение получается в случае, если в ячейке регулярной сетки отсутствует соответствующий тип объектов. Со значением *Null* мы не сможем корректно рассчитать оставшуюся площадь, поэтому необходимо заменить его на *0*. Для этого воспользуемся запросами к атрибутивной таблице и калькулятором полей.

1. Сохраните слой регулярной сетки с присоединенными полями как постоянный класс объектов, щёлкнув правой кнопкой мыши по нему и выбрав соответствующий пункт меню.

2. Откройте атрибутивную таблицу слоя регулярной сетки и нажмите на кнопку ![](images/Ex06_SpatRelations/Selection.png).

3. В открывшемся окне составьте выражение, которое выбирает все значения *Null* в поле с площадью растительности. Не пишите выражение вручную, а используйте конструктор в средней и правой панели.

    ![](images/Ex06_SpatRelations/Select_by_Expression.png)
    
        > Подсказка: чтобы использовать значения полей в выражении, найдите в средней панели группу «Поля и значения». Добавляйте поля в выражение, кликая по их названиям дважды левой кнопкой мыши.

Если запрос корректен, в атрибутивной таблице выберутся соответствующие строки.

4. Для выбранных строк необходимо задать значение *0* для соответствующего поля площади через калькулятор полей. Будьте внимательны – работайте с уже существующим полем, а не создавайте новое.

5. Аналогичную последовательность действий с выборкой и калькулятором полей проделайте для оставшихся трёх типов объектов.

6. С помощью калькулятора полей рассчитайте площадь оставшихся объектов, используя конструктор.

    ![](images/Ex06_SpatRelations/Field_Calculator.png)

## Настройка символики {#spatrelations-symbology}
[В начало упражнения ⇡](#spatrelations)

1. Используйте способ картодиаграмм для визуализации полученных соотношений.

    ![](images/Ex06_SpatRelations/Result.png)
    
     **Скриншот 2:** Визуализация результата

2. Сохраните документ карты.
